#
# Variable expansion test
#

bundle cfagent testvar

{
var:

  "arglist"    slist => { "-d", "-x", "-y" };
  "dirlist"    slist => { "one", "two", "three" };
  "serverlist" slist => { "server1", "server2 "};

   # if dtype is cf_list then insert list in rval

  "serverlist2" slist => { "$(serverlist)" }



files:

    # Get all directories from all servers

   "$(dirlist)/file" copyfrom => "$(serverlist)";

    # Get all directories from all servers, set owners

   "$(dirlist)/file" copyfrom => "$(serverlist)",
                     access   => setowner("$(serverlist)");


  #
  # Copy named files *to* separate named dirs, e.g. for vm config
  #

  "$(basedir)/$(named_files)/vm.conf"

           copyfrom      => mycopy("/$(basedir)/$(named_files).conf","server"),
           access        => myaccess,
           file_select   => crit;
  #        loopiteration => iter_policy
          

  #
  # Copy named files *from* separate named hosts - aggregation
  #

  "$(basedir)/data_from_$(servers)/$(named_files).conf"

           copyfrom      => mycopy("/$(basedir)/$(named_files).conf","$(servers)"),
           access        => myaccess,
           file_select  => crit;
  #        loopiteration => iter_policy
          


  # 
  # Now copy a single set of files to different destinations on same server
  #

  "$(basedir)/$(named_files)/vm.conf"

           copyfrom    => mycopy("/$(basedir)/fixed.conf","server"),
           access      => myaccess,
           file_select      => crit;


alert:

   # Say hey serverX to all serverX, for each X

   "Hey $(serverlist)" -> "$(serverlist)";

   # Same

   "Hey $(serverlist)" -> "$(serverlist2)";
}

###########################################################

body access setowner(slist)

{
# There is no iteration inside bodies, period -- but the
# iterator will penetrate through variable passing

owners => "$(slist)";
}

