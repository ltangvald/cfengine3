#  Copyright (C) Cfengine AS

#  This file is part of Cfengine 3 - written and maintained by Cfengine AS.

#  This program is free software; you can redistribute it and/or modify it
#  under the terms of the GNU General Public License as published by the
#  Free Software Foundation; version 3.

#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA

# To the extent this program is licensed as part of the Enterprise
# versions of Cfengine, the applicable Commerical Open Source License
# (COSL) may apply to this file if you as a licensee so wish it. See
# included file COSL.txt.

#
# Variable expansion test
#

bundle cfagent testvar

{
var:

  "arglist"    slist => { "-d", "-x", "-y" };
  "dirlist"    slist => { "one", "two", "three" };
  "serverlist" slist => { "server1", "server2 "};

   # if dtype is cf_list then insert list in rval

  "serverlist2" slist => { "$(serverlist)" }



files:

    # Get all directories from all servers

   "$(dirlist)/file" copyfrom => "$(serverlist)";

    # Get all directories from all servers, set owners

   "$(dirlist)/file" copyfrom => "$(serverlist)",
                     access   => setowner("$(serverlist)");


  #
  # Copy named files *to* separate named dirs, e.g. for vm config
  #

  "$(basedir)/$(named_files)/vm.conf"

           copyfrom      => mycopy("/$(basedir)/$(named_files).conf","server"),
           access        => myaccess,
           file_select   => crit;
  #        loopiteration => iter_policy
          

  #
  # Copy named files *from* separate named hosts - aggregation
  #

  "$(basedir)/data_from_$(servers)/$(named_files).conf"

           copyfrom      => mycopy("/$(basedir)/$(named_files).conf","$(servers)"),
           access        => myaccess,
           file_select  => crit;
  #        loopiteration => iter_policy
          


  # 
  # Now copy a single set of files to different destinations on same server
  #

  "$(basedir)/$(named_files)/vm.conf"

           copyfrom    => mycopy("/$(basedir)/fixed.conf","server"),
           access      => myaccess,
           file_select      => crit;


alert:

   # Say hey serverX to all serverX, for each X

   "Hey $(serverlist)" -> "$(serverlist)";

   # Same

   "Hey $(serverlist)" -> "$(serverlist2)";
}

###########################################################

body access setowner(slist)

{
# There is no iteration inside bodies, period -- but the
# iterator will penetrate through variable passing

owners => "$(slist)";
}

